@model WAMVC.Models.PedidoModel

@{
    ViewData["Title"] = "Crear Pedido";
}

<h1>Crear Pedido</h1>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<hr />
<div class="row">
    <div class="col-md-8">
        <form asp-action="Create" method="post">
            <div asp-validation-summary="All" class="text-danger mb-3"></div>
            
            <div class="form-group mb-3">
                <label asp-for="IdCliente" class="control-label"></label>
                <select asp-for="IdCliente" class="form-control form-select" asp-items="ViewBag.IdCliente">
                    <option value="">-- Seleccione un Cliente --</option>
                </select>
                <span asp-validation-for="IdCliente" class="text-danger"></span>
            </div>
            
            <div class="form-group mb-3">
                <label asp-for="FechaPedido" class="control-label"></label>
                <input asp-for="FechaPedido" class="form-control" type="date" />
                <span asp-validation-for="FechaPedido" class="text-danger"></span>
            </div>
            
            <div class="form-group mb-3">
                <label asp-for="Estado" class="control-label"></label>
                <select asp-for="Estado" class="form-control form-select">
                    <option value="">-- Seleccione un Estado --</option>
                    <option value="Pendiente" selected>Pendiente</option>
                    <option value="En proceso">En proceso</option>
                    <option value="Completado">Completado</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
                <span asp-validation-for="Estado" class="text-danger"></span>
            </div>
            
            <div class="form-group mb-3">
                <label asp-for="MontoTotal" class="control-label"></label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input asp-for="MontoTotal" class="form-control" type="number" step="0.01" min="0" value="0" />
                </div>
                <span asp-validation-for="MontoTotal" class="text-danger"></span>
                <small class="form-text text-muted">Ingrese el monto total del pedido manualmente.</small>
            </div>
            
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                Una vez creado el pedido, podrá agregar productos en la sección de Detalles de Pedido.
            </div>
            
            <div class="form-group mt-4">
                <input type="submit" value="Crear Pedido" class="btn btn-primary" />
                <a asp-action="Index" class="btn btn-secondary ms-2">Volver a la lista</a>
            </div>
        </form>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Información de Depuración</h5>
            </div>
            <div class="card-body">
                <p><strong>Estado del Modelo:</strong></p>
                <ul>
                    <li>Cliente ID: @Model?.IdCliente</li>
                    <li>Fecha: @Model?.FechaPedido.ToString("yyyy-MM-dd")</li>
                    <li>Estado: @Model?.Estado</li>
                    <li>Monto: @Model?.MontoTotal</li>
                </ul>
                
                @if (!ViewData.ModelState.IsValid)
                {
                    <p><strong>Errores de Validación:</strong></p>
                    <ul class="text-danger">
                        @foreach (var error in ViewData.ModelState)
                        {
                            @foreach (var errorMsg in error.Value.Errors)
                            {
                                <li>@error.Key: @errorMsg.ErrorMessage</li>
                            }
                        }
                    </ul>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Establecer la fecha actual si está vacía
            var fechaInput = document.getElementById('FechaPedido');
            if (fechaInput && !fechaInput.value) {
                var today = new Date().toISOString().split('T')[0];
                fechaInput.value = today;
            }
            
            // Log para depuración en el navegador
            console.log('Formulario cargado');
            
            // Validación adicional al enviar
            var form = document.querySelector('form');
            form.addEventListener('submit', function(e) {
                var cliente = document.getElementById('IdCliente').value;
                var estado = document.getElementById('Estado').value;
                
                console.log('Enviando formulario...');
                console.log('Cliente seleccionado:', cliente);
                console.log('Estado seleccionado:', estado);
                
                if (!cliente) {
                    alert('Por favor seleccione un cliente');
                    e.preventDefault();
                    return false;
                }
                
                if (!estado) {
                    alert('Por favor seleccione un estado');
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}
